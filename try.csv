Step_ID,Step_Name,Step_Type,Description,Input,Output,Next_Step,Error_Handler,Time_Limit
1,Client Request,Start,Client sends POST request to /extract-bill-data,JSON with document URL,Request object,2,,
2,API Gateway,Process,FastAPI receives and validates request schema,Request object,Validated request,3,ERROR_1,
3,Timeout Wrapper,Process,Apply 180s timeout protection,Validated request,Protected execution context,4,ERROR_2,180s
4,Thread Pool Execution,Process,Execute in async thread pool,Protected context,Execution promise,5,ERROR_3,
5,Document Download,Process,Download document from URL using requests library,Document URL,Document bytes,6,ERROR_4,60s
6,File Type Detection,Decision,Detect if PDF or Image based on magic bytes,Document bytes,File type (PDF/Image),7,,
7,Route Handler,Router,Route to PDF or Image handler based on type,File type + Document bytes,Processing path,8A or 8B,,
8A,PDF Handler,Process,Process PDF document,PDF bytes,PDF object,9,,
8B,Image Handler,Process,Process single image,Image bytes,Image object,11,,
9,PDF Page Iterator,Process,Extract individual pages using PyMuPDF,PDF object,List of pages,10,,25 pages max
10,Digital Check,Decision,Check if page is digital or scanned,PDF page,Page type (digital/scanned),10A or 10B,,
10A,Extract Text,Process,Extract text from digital PDF page,Digital page,Text content + Page image,11,,
10B,Render to Image,Process,Render scanned PDF page to image (zoom=2.0),Scanned page,Page image,11,,
11,Image Preprocessing,Process,Enhance image quality,Raw image,Preprocessed image,12,,
12,Parallel Processing Setup,Process,Create ThreadPoolExecutor with 3 workers,All preprocessed pages,Worker pool,13,,
13,Worker Assignment,Process,Assign pages to workers with 1s stagger,Worker pool + Pages,Page assignments,14,,
14,Page Processing,Parallel,Process each page in parallel (30s timeout per page),Single page,Page result,15,ERROR_5,30s per page
15,Prompt Selection,Decision,Select appropriate prompt based on context,Page data + Attempt number + Page type,Selected prompt,16,,
16,Gemini API Call,Process,Call Gemini Vision API with image and prompt,Image + Prompt + Config,API response,17,ERROR_6,
17,Response Handler,Decision,Check API response status,API response,Response status,18A or 18B or 18C,,
18A,Success Path,Process,Extract text from successful response,Success response,Raw JSON text,19,,
18B,Safety Block,Process,Handle safety filter block,Blocked response,Empty result,23,ERROR_7,
18C,Retry Path,Decision,Check retry count and retry if < 2,Failed response + Retry count,Retry decision,16 or 23,,2 retries max
19,JSON Parsing Strategy 1,Process,Attempt direct json.loads(),Raw JSON text,Parsed JSON or Error,20A or 20,,
20,JSON Parsing Strategy 2,Process,Extract from markdown code blocks,Raw JSON text,Parsed JSON or Error,20A or 21,,
21,JSON Parsing Strategy 3,Process,Regex extract JSON object,Raw JSON text,Parsed JSON or Error,20A or 22,,
22,JSON Parsing Strategy 4,Process,Fix common issues (commas quotes truncation),Raw JSON text,Fixed JSON,22A or 23,,
22A,Retry Parse,Process,Attempt parse after fixes,Fixed JSON,Parsed JSON or Error,20A or 24,,
23,JSON Parsing Strategy 5,Process,Regex item extraction (last resort),Raw JSON text,Reconstructed JSON,20A or ERROR_8,,
20A,Parse Success,Process,JSON successfully parsed,Parsed JSON,JSON object,25,,
24,Validation Stage,Process,Validate parsed JSON structure,JSON object,Validation result,25A or ERROR_9,,
25,Schema Validation,Process,Validate against Pydantic models,JSON object,Validated items,26,,
25A,Field Validation,Process,Validate individual fields (name amount qty rate),Validated items,Field-validated items,26,,
26,Bounds Checking,Process,Check value ranges (0-100M for amount 0-10K for qty),Field-validated items,Bounds-checked items,27,,
27,Cross Validation,Process,Validate rate × quantity ≈ amount (±10%),Bounds-checked items,Cross-validated items,28,,
28,Hallucination Filter,Process,Filter out skip keywords and invalid entries,Cross-validated items,Filtered items,29,,
29,Deduplication,Process,Remove duplicate (name amount) pairs,Filtered items,Deduplicated items,30,,
30,Page Result Complete,Process,Create PageResult object,Deduplicated items + Page number,PageResult,31,,
31,All Pages Complete Check,Decision,Check if all pages processed,List of PageResults,Completion status,32 or 14,,
32,Merge Pages,Process,Combine all page results,List of PageResults,Combined results,33,,
33,Token Counting,Process,Count total tokens used,API responses,Token usage stats,34,,
34,Format Response,Process,Create final JSON response structure,Combined results + Token stats,Final response JSON,35,,
35,Return Response,End,Send response back to client,Final response JSON,HTTP response,,,
ERROR_1,Validation Error,Error,Invalid request schema,Request object,Error response 400,ERROR_END,,
ERROR_2,Timeout Error,Error,Overall request timeout exceeded,Execution context,Error response 504,ERROR_END,,
ERROR_3,Execution Error,Error,Thread pool execution failed,Execution promise,Error response 500,ERROR_END,,
ERROR_4,Download Error,Error,Failed to download document,Document URL,Error response 400/500,ERROR_END,,
ERROR_5,Page Timeout,Error,Page processing timeout,Page data,Empty page result,31,,
ERROR_6,API Error,Error,Gemini API call failed,API request,Error status,18C,,
ERROR_7,Safety Filter,Error,Content blocked by safety filter,Blocked content,Empty page result,31,,
ERROR_8,Parse Failure,Error,All parsing strategies failed,Raw text,Empty page result,31,,
ERROR_9,Validation Failure,Error,Validation rules not met,Invalid items,Filtered items,26,,
ERROR_END,Error Response,End,Return error response to client,Error details,HTTP error response,,,